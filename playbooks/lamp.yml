- name: Install LAMP env.
  hosts: all:!infra
  become: True
  become_method: sudo

  pre_tasks:
    - include_vars: "./os_vars/{{ ansible_distribution_release }}.yml"
      tags: ['always']
    - include_vars: "./../inventory/{{ platform }}/group_vars/{{ item }}.yml"
      with_items:
        - owners
      tags: ['resources','sshkeys']
    - apt: update_cache=yes cache_valid_time=3600

  roles:
    - role: locale
      tags: ['locale']
    - role: fail2ban
      tags: ['fail2ban']
    - role: system
      tags: ['system']
    - role: users
      tags: ['users']
    - role: ufw
      tags: ['ufw']
    - role: ntp
      tags: ['ntp']
    - role: postfix
      tags: ['postfix']
    - role: letsencrypt
      tags: ['letsencrypt', 'acme']
    - role: httpd
      tags: ['httpd']
    - role: varnish
      tags: ['varnish']
    - role: nginx
      tags: ['nginx']
    - role: fastcgi
      tags: ['php','httpd']
      # before Debian Stretch
    - role: mysql
      tags: ['mysql']
      when: ansible_distribution == 'Debian' and ansible_distribution_major_version < '9'
    - role: php
      tags: ['php']
      when: ansible_distribution == 'Debian' and ansible_distribution_major_version < '9'
    - role: php-pecl
      tags: ['php']
      when: ansible_distribution == 'Debian' and ansible_distribution_major_version < '9'
    - role: solr
      tags: ['solr']
      when: ansible_distribution == 'Debian' and ansible_distribution_major_version < '9'
      # Debian Stretch
    - role: mariadb
      tags: ['mysql', 'mariadb']
      when: ansible_distribution == 'Debian' and ansible_distribution_major_version >= '9'
    - role: php7
      tags: ['php']
      when: ansible_distribution == 'Debian' and ansible_distribution_major_version >= '9'
    - role: phpdevtools
      tags: ['phpdevtools']
    - role: solr-multicore
      tags: ['solr']
      when: ansible_distribution == 'Debian' and ansible_distribution_major_version >= '9'
    - role: redis
      tags: ['redis']
    - role: memcached
      tags: ['memcached']
    - role: vsftpd
      tags: ['vsftpd']
